# 前后端分离架构说明

## 📊 架构概览

```
┌─────────────┐         HTTP API         ┌─────────────┐
│             │ ◄──────────────────────► │             │
│   前端应用   │   localhost:3001/api    │  后端服务器  │
│  (React)    │                          │  (Express)  │
│             │                          │             │
└─────────────┘                          └──────┬──────┘
  localhost:3000                                │
                                                │
                                         ┌──────▼──────┐
                                         │  JSON 文件   │
                                         │  数据存储    │
                                         └─────────────┘
```

## 🎯 主要改动

### 1. 创建后端服务器

**位置**: `backend/` 目录

**文件结构**:
```
backend/
├── server.js                # Express服务器主文件
├── dataStore.js             # 数据存储模块
├── data/                    # 数据文件目录
│   ├── poker-history.json   # 游戏历史
│   └── poker-favorites.json # 收藏玩家
├── package.json             # 依赖配置
├── README.md                # 文档
├── test-api.sh              # API测试脚本
├── .gitignore               # Git忽略配置
└── 启动后端服务器.command    # 启动脚本
```

**核心功能**:
- RESTful API 接口
- JSON 文件数据存储
- CORS 跨域支持
- 错误处理

### 2. 整理前端结构

**位置**: `frontend/` 目录

**文件结构**:
```
frontend/
├── src/                     # 源代码
│   ├── components/          # React组件
│   ├── utils/               # 工具函数
│   │   └── storage.js       # API存储封装
│   ├── App.jsx
│   ├── main.jsx
│   └── index.css
├── index.html               # 入口HTML
├── package.json             # 依赖配置
├── vite.config.js           # Vite配置
├── tailwind.config.js       # Tailwind配置
├── postcss.config.js        # PostCSS配置
├── .gitignore               # Git忽略配置
├── 启动开发服务器.command    # 启动脚本
└── README.md                # 文档
```

**核心改动**:
- `src/utils/storage.js`: 从 `localStorage` 改为调用后端 API
- 保持接口不变，确保其他组件无需修改
- 添加错误处理

**API 地址**: `http://localhost:3001/api`

## 🚀 启动方式

### 方式一：一键启动（推荐）

双击 `启动全部服务.command`

这会自动：
1. 检查并安装依赖
2. 启动后端服务器（端口3001）
3. 启动前端服务器（端口3000）
4. 显示访问地址

### 方式二：分别启动

**终端1 - 后端**:
```bash
cd backend
npm install    # 首次运行
npm start
```

**终端2 - 前端**:
```bash
npm install    # 首次运行
npm run dev
```

### 方式三：使用启动脚本

**启动后端**:
```bash
./backend/启动后端服务器.command
```

**启动前端**:
```bash
./frontend/启动开发服务器.command
```

## 📡 API 接口

### 基础信息
- **地址**: `http://localhost:3001/api`
- **格式**: JSON
- **跨域**: 已配置 CORS

### 接口列表

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/health | 健康检查 |
| GET | /api/history | 获取历史记录 |
| POST | /api/history | 添加游戏记录 |
| PUT | /api/history | 更新所有历史 |
| DELETE | /api/history/:id | 删除游戏记录 |
| GET | /api/favorites | 获取收藏列表 |
| PUT | /api/favorites | 更新收藏列表 |

### 测试 API

```bash
# 方式一：使用测试脚本
cd backend
./test-api.sh

# 方式二：使用 curl
curl http://localhost:3001/api/health
curl http://localhost:3001/api/history
curl http://localhost:3001/api/favorites
```

## 💾 数据存储

### 存储位置
`backend/data/` 目录下的 JSON 文件

### 数据文件

1. **poker-history.json** - 游戏历史记录
   ```json
   [
     {
       "id": 1698765432000,
       "gameName": "10月27日周五",
       "date": "2023-10-27T12:00:00.000Z",
       "players": [...]
     }
   ]
   ```

2. **poker-favorites.json** - 收藏的玩家
   ```json
   ["玩家A", "玩家B", "玩家C"]
   ```

### 数据备份

```bash
# 备份
cp -r backend/data backend/data_backup_$(date +%Y%m%d)

# 恢复
cp -r backend/data_backup_20251028/* backend/data/
```

## 🔧 配置说明

### 修改端口

**后端端口** (`backend/server.js`):
```javascript
const PORT = 3001;  // 改为你想要的端口
```

**前端端口** (`vite.config.js`):
```javascript
server: {
  port: 3000,  // 改为你想要的端口
}
```

**前端 API 地址** (`frontend/src/utils/storage.js`):
```javascript
const API_BASE_URL = 'http://localhost:3001/api';
```

### 生产环境配置

1. **修改 API 地址**:
   ```javascript
   // frontend/src/utils/storage.js
   const API_BASE_URL = process.env.NODE_ENV === 'production' 
     ? 'https://your-domain.com/api'
     : 'http://localhost:3001/api';
   ```

2. **限制 CORS 来源**:
   ```javascript
   // backend/server.js
   app.use(cors({
     origin: 'https://your-domain.com'
   }));
   ```

## ✅ 优势

### 与之前 localStorage 方案对比

| 特性 | LocalStorage | 后端存储 |
|------|-------------|---------|
| 多设备同步 | ❌ 不支持 | ✅ 支持 |
| 数据备份 | ❌ 困难 | ✅ 简单 |
| 数据容量 | 5-10MB | 无限制 |
| 协作使用 | ❌ 不支持 | ✅ 支持 |
| 数据持久性 | 可能丢失 | ✅ 可靠 |
| 跨浏览器 | ❌ 不支持 | ✅ 支持 |

### 现在可以做到

1. ✅ 多人同时访问同一后端
2. ✅ 手机和电脑共享数据
3. ✅ 数据集中管理和备份
4. ✅ 为未来扩展打下基础（用户系统、权限管理等）

## 🔍 故障排查

### 问题1: 后端启动失败

**检查**:
```bash
# 检查端口是否被占用
lsof -i :3001

# 查看错误日志
cat backend.log
```

**解决**: 修改端口或关闭占用进程

### 问题2: 前端无法连接后端

**检查**:
1. 后端是否正常运行
   ```bash
   curl http://localhost:3001/api/health
   ```

2. 查看浏览器控制台错误

3. 检查 CORS 配置

### 问题3: 数据没有保存

**检查**:
1. `backend/data/` 目录是否存在
2. 后端是否有写入权限
3. 查看后端日志

### 问题4: 旧数据迁移

如果之前使用 localStorage，数据在浏览器中：

1. 打开浏览器控制台
2. 运行：
   ```javascript
   // 导出历史记录
   console.log(localStorage.getItem('poker-history'))
   
   // 导出收藏列表
   console.log(localStorage.getItem('poker-favorites'))
   ```
3. 复制输出的 JSON
4. 保存到对应的后端数据文件中

## 📚 下一步可能的扩展

1. **用户系统**: 添加登录注册功能
2. **数据库**: 升级到 MongoDB 或 PostgreSQL
3. **权限管理**: 不同用户看不同的数据
4. **实时同步**: 使用 WebSocket 实现多人实时协作
5. **数据分析**: 添加更多统计图表
6. **导出功能**: 导出为 Excel、PDF 等格式

## 🎉 总结

现在你的应用已经是一个真正的前后端分离架构了！

- **前端**: React + Vite，负责界面展示
- **后端**: Node.js + Express，负责数据管理
- **存储**: JSON 文件，简单可靠

可以开始使用了，祝你玩得开心！🎮

